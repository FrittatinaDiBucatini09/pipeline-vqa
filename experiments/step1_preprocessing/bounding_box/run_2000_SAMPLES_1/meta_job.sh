#!/bin/bash
# ==============================================================================
# AUTO-GENERATED META-JOB: Medical VQA Pipeline
# Generated by the Pipeline Orchestrator
# ==============================================================================

#SBATCH --job-name=vqa_pipeline
#SBATCH --output=/home/rbalzani/medical-vqa/Thesis/orchestrator_runs/run_20260217_022520/slurm_metajob_%j.out
#SBATCH --error=/home/rbalzani/medical-vqa/Thesis/orchestrator_runs/run_20260217_022520/slurm_metajob_%j.err
#SBATCH -N 1
#SBATCH --gpus=nvidia_geforce_rtx_3090:1
#SBATCH -w faretra
#SBATCH --time=15:00:00
# Send SIGTERM 60s before SIGKILL on timeout, so trap can clean up
#SBATCH --signal=B:TERM@60

# Fail-fast: exit immediately if any command fails
set -e

# ==============================================================================
# GLOBAL ENVIRONMENT
# ==============================================================================
export PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
export ORCH_OUTPUT_DIR="/home/rbalzani/medical-vqa/Thesis/orchestrator_runs/run_20260217_022520"
export DATA_FILE_OVERRIDE="mimic_ext_stratified_2000_samples.csv"

# ==============================================================================
# ERROR HANDLING & REPORTING
# ==============================================================================
CURRENT_STEP="initializing"
PIPELINE_START=$(date '+%Y-%m-%d %H:%M:%S')

# Snapshot running containers before pipeline starts
PRE_CONTAINERS=$(docker ps -q 2>/dev/null | sort)

cleanup() {
    EXIT_CODE=$?
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

    # Kill any Docker containers started during this meta-job
    POST_CONTAINERS=$(docker ps -q 2>/dev/null | sort)
    NEW_CONTAINERS=$(comm -13 <(echo "$PRE_CONTAINERS") <(echo "$POST_CONTAINERS") 2>/dev/null)
    if [ -n "$NEW_CONTAINERS" ]; then
        echo "[$TIMESTAMP] Stopping orphan Docker containers..."
        docker kill $NEW_CONTAINERS 2>/dev/null || true
        sleep 2
    fi

    echo ''
    echo '============================================================'
    if [ $EXIT_CODE -ne 0 ]; then
        echo "[$TIMESTAMP] PIPELINE FAILED at step: $CURRENT_STEP"
        echo "Exit code: $EXIT_CODE"
        echo "Started:   $PIPELINE_START"
        echo "Failed:    $TIMESTAMP"
    else
        echo "[$TIMESTAMP] PIPELINE COMPLETED SUCCESSFULLY"
        echo "Started:  $PIPELINE_START"
        echo "Finished: $TIMESTAMP"
    fi
    echo '============================================================'
}
trap cleanup EXIT
trap 'exit 143' TERM  # Ensure SIGTERM (from SLURM timeout) triggers EXIT trap

echo "============================================================"
echo "Medical VQA Pipeline - Meta-Job"
echo "Run directory: /home/rbalzani/medical-vqa/Thesis/orchestrator_runs/run_20260217_022520"
echo "Stages: 3"
echo "Dataset override: mimic_ext_stratified_2000_samples.csv"
echo "============================================================"

# ==============================================================================
# STEP 1: Preprocessing: Bounding Box
# ==============================================================================
CURRENT_STEP="1 - Preprocessing: Bounding Box"
echo "[$(date '+%Y-%m-%d %H:%M:%S')] START: $CURRENT_STEP"

cd "/home/rbalzani/medical-vqa/Thesis/preprocessing/bounding_box"
bash submit_bbox_preprocessing.sh configs/exp/S_question_T0.45_C_crf_on_P_loose.conf

echo "[$(date '+%Y-%m-%d %H:%M:%S')] DONE:  $CURRENT_STEP"


# ==============================================================================
# BRIDGE: Preprocessing (bbox_preproc) -> VQA Generation
# ==============================================================================
# The preprocessing stage generates:
#   1. Modified/annotated images
#   2. vqa_manifest.csv mapping new image paths to original questions
# This bridge wires those artifacts into the VQA generation stage.

PREPROC_OUTPUT_DIR="/home/rbalzani/medical-vqa/Thesis/preprocessing/bounding_box/results"

echo "[BRIDGE] Stage: bbox_preproc"
echo "[BRIDGE] Checking for VQA manifest at $PREPROC_OUTPUT_DIR/vqa_manifest.csv"

if [ ! -f "$PREPROC_OUTPUT_DIR/vqa_manifest.csv" ]; then
    echo "[ERROR] VQA manifest not found at $PREPROC_OUTPUT_DIR/vqa_manifest.csv"
    echo "[ERROR] The preprocessing stage may have failed to generate the bridge file."
    exit 1
fi

MANIFEST_ROWS=$(wc -l < "$PREPROC_OUTPUT_DIR/vqa_manifest.csv")
echo "[BRIDGE] VQA manifest found: $((MANIFEST_ROWS - 1)) image-question pairs"

export DATA_FILE_OVERRIDE="$PREPROC_OUTPUT_DIR/vqa_manifest.csv"
export VQA_IMAGE_PATH="$PREPROC_OUTPUT_DIR"

echo "[BRIDGE] DATA_FILE_OVERRIDE=$DATA_FILE_OVERRIDE"
echo "[BRIDGE] VQA_IMAGE_PATH=$VQA_IMAGE_PATH"

# ==============================================================================
# STEP 2: VQA Generation
# ==============================================================================
CURRENT_STEP="2 - VQA Generation"
echo "[$(date '+%Y-%m-%d %H:%M:%S')] START: $CURRENT_STEP"

cd "/home/rbalzani/medical-vqa/Thesis/vqa"
bash submit_generation.sh configs/generation/hard_coded_gen.conf

echo "[$(date '+%Y-%m-%d %H:%M:%S')] DONE:  $CURRENT_STEP"

# ==============================================================================
# STEP 3: VQA Evaluation (Judge)
# ==============================================================================
CURRENT_STEP="3 - VQA Evaluation (Judge)"
echo "[$(date '+%Y-%m-%d %H:%M:%S')] START: $CURRENT_STEP"

cd "/home/rbalzani/medical-vqa/Thesis/vqa" || exit 1
PHYS_DIR=$(pwd)

# Load HF_TOKEN from .env if not already set
if [ -z "$HF_TOKEN" ] && [ -f "$PHYS_DIR/.env" ]; then
    echo "  Loading secrets from .env..."
    set -a
    source "$PHYS_DIR/.env"
    set +a
fi

IMAGE_NAME="med_vqa_project:3090"

# Verify Docker image exists
if [[ -z "$(docker images -q "$IMAGE_NAME" 2>/dev/null)" ]]; then
    echo "[ERROR] Docker image '$IMAGE_NAME' not found. Build it first."
    exit 1
fi

echo "  Launching VQA Judge container..."
echo "  Config: configs/judge/hard_coded_judge.conf"

docker run --rm \
    --name "metajob_${SLURM_JOB_ID:-local}_judge" \
    --gpus "device=${CUDA_VISIBLE_DEVICES:-0}" \
    --shm-size=16g \
    -v "$PHYS_DIR":/workspace \
    -v /llms:/llms \
    -e HF_HOME=/llms \
    -e HF_TOKEN="${HF_TOKEN:-}" \
    "$IMAGE_NAME" \
    /bin/bash /workspace/scripts/run_judge.sh "configs/judge/hard_coded_judge.conf"

echo "[$(date '+%Y-%m-%d %H:%M:%S')] DONE:  $CURRENT_STEP"
